<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√°gina Inicial</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fa-regular fa-heart"></i>
                </div>
                <span>Voluntariado<br><strong>Liferay</strong></span>
            </div>

            <nav class="navigation">
                <p>Navega√ß√£o</p>
                <ul>
                    <li><a href="inicio.html" class="active"><i class="fa-solid fa-house"></i> In√≠cio</a></li>
                    <li><a href="explorar.html"><i class="fa-solid fa-magnifying-glass"></i> Explorar</a></li>
                    <li><a href="criar-oportunidade.html"><i class="fa-solid fa-circle-plus"></i> Criar Oportunidade</a></li>
                    <li><a href="impacto.html"><i class="fa-solid fa-chart-line"></i> Impacto</a></li>
                    <li><a href="testemunhos.html"><i class="fa-solid fa-comments"></i> Testemunhos</a></li>
                    <li><a href="MeuPerfil.html"><i class="fa-solid fa-user"></i> Meu perfil</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="MeuPerfil.html" class="user-info-link">
                    <div class="user-info">
                        <div class="avatar-small">...</div>
                        <div class="user-details">
                            <strong>Carregando...</strong>
                            <span id="sidebar-horas">0h de voluntariado</span>
                        </div>
                    </div>
                </a>
                
                <button class="logout-button">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="page-header">
                <div>
                    <h1 id="header-greeting">Ol√°! <span class="wave-emoji">üëã</span></h1>
                    <p>Pronto para fazer a diferen√ßa hoje?</p>
                </div>
                <a href="criar-oportunidade.html" style="text-decoration: none;">
                    <button class="create-opportunity-btn" style="cursor: pointer;">
                        <i class="fa-solid fa-plus"></i> Criar Oportunidade
                    </button>
                </a>
            </div>

            <section class="stats-grid">
                <div class="stat-card">
                    <div class="card-header">
                        <span>Oportunidades abertas</span>
                        <i class="fa-solid fa-briefcase icon-blue"></i>
                    </div>
                    <span class="stat-value" id="stat-oportunidades">0</span>
                </div>
                <div class="stat-card">
                    <div class="card-header">
                        <span>Minhas horas</span>
                        <i class="fa-solid fa-clock icon-green"></i>
                    </div>
                    <span class="stat-value" id="stat-horas">0h</span>
                </div>
                <div class="stat-card">
                    <div class="card-header">
                        <span>Pr√≥ximas atividades</span>
                        <i class="fa-solid fa-calendar-alt icon-teal"></i>
                    </div>
                    <span class="stat-value" id="stat-proximas">0</span>
                </div>
                <div class="stat-card">
                    <div class="card-header">
                        <span>Volunt√°rios totais</span>
                        <i class="fa-solid fa-users icon-purple"></i>
                    </div>
                    <span class="stat-value" id="stat-total-geral">0</span>
                </div>
            </section>

            <div class="home-layout">
                
                <div class="main-column">
                    
                    <div class="widget-card">
                        <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Recomendados para Voc√™</h2>
                        <ul class="recommendation-list" id="lista-recomendados">
                            </ul>
                    </div>
                    
                    <div class="widget-card">
                        <h2><i class="fa-regular fa-calendar-days"></i> Minhas pr√≥ximas atividades</h2>
                        
                        <div id="container-minhas-atividades">
                            <div class="empty-state" id="empty-state-atividades" style="padding: 30px 0;">
                                <i class="fa-regular fa-calendar-xmark"></i>
                                <p>Voc√™ ainda n√£o est√° inscrito em nenhuma atividade futura.</p>
                            </div>
                            <ul class="recommendation-list" id="lista-minhas-atividades" style="display: none;">
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="sidebar-column">
                    
                    <div class="widget-card impact-card-blue">
                        <h2><i class="fa-regular fa-heart"></i> Seu Impacto</h2>
                        
                        <div class="impact-main-value">
                            <span id="impact-horas-valor">0</span>
                            <p>Horas de voluntariado</p>
                        </div>
                        
                        <div class="impact-sub-stat">
                            <span>Atividades conclu√≠das</span>
                            <strong id="impact-concluidas">0</strong>
                        </div>
                        <div class="impact-sub-stat">
                            <span>Pr√≥ximas atividades</span>
                            <strong id="impact-proximas">0</strong>
                        </div>

                        <a href="MeuPerfil.html" class="ver-perfil-link-styled">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i> Ver meu perfil
                        </a>
                    </div>
                    
                    <div class="widget-card">
                        <h2>Testemunhos Recentes</h2>
                        <div id="lista-testemunhos-home" style="display: flex; flex-direction: column; gap: 15px;">
                        </div>
                        
                        <div class="empty-state" id="empty-state-testemunhos" style="padding: 30px 0;">
                            <i class="fa-regular fa-comment-dots"></i>
                            <p>Nenhum testemunho ainda.</p>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>
    
    <script src="app.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Atualiza o H1 com o nome do usu√°rio logado
            atualizarSaudacao();

            try {
                // 1. Busca TODAS as oportunidades
                const response = await fetch('/api/oportunidades');
                const oportunidades = await response.json();

                // 2. Filtra: Pega apenas as 3 primeiras (Slice)
                const recentes = oportunidades.slice(0, 3); 
                const lista = document.getElementById('lista-recomendados');
                lista.innerHTML = ''; 

                // Se lista vazia, mostra mensagem
                if (recentes.length === 0) {
                    lista.innerHTML = '<p style="padding: 20px; color: #666; text-align:center;">Nenhuma oportunidade recente.</p>';
                    return;
                }

                // 3. Renderiza√ß√£o dos Cards
                recentes.forEach(op => {
                    const item = document.createElement('li');
                    item.className = 'recommendation-item';

                    // Formata√ß√£o de Data e Fuso Hor√°rio
                    const dataObj = new Date(op.data_evento);
                    const dataUser = new Date(dataObj.getTime() + dataObj.getTimezoneOffset() * 60000);
                    const dataFormatada = dataUser.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });

                    // Mapa de Cores para Tags
                    let tagClass = 'tag-blue';
                    const tipo = op.tipo_voluntariado ? op.tipo_voluntariado.tipo : 'Geral';
                    const mapTipos = { 'Meio Ambiente': 'tag-green', 'Educa√ß√£o': 'tag-purple', 'Sa√∫de': 'tag-red', 'Cultura': 'tag-red', 'Assist√™ncia Social': 'tag-yellow' };
                    if(mapTipos[tipo]) tagClass = mapTipos[tipo];

                    // Template String HTML
                    item.innerHTML = `
                        <div class="item-details">
                            <span class="tag-novo" background-color: #d3e6fa; /* azul padrao */
                            color: #007bff;
                            font-weight: 700;
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-size: 10px;
                            text-transform: uppercase;
                            margin-bottom: 5px;
                            vertical-align: middle;
                            float: right;">Novo</span>
                            <h3>${op.titulo}</h3>
                            <span class="tag ${tagClass}">${tipo}</span>
                            <p>${op.descricao ? op.descricao : ''}</p>
                            <div class="item-info">
                                <span><i class="fa-regular fa-calendar-days"></i> ${dataFormatada}</span>
                                <span><i class="fa-solid fa-location-dot"></i> ${op.local_evento.split(',')[0]}</span>
                            </div>
                        </div>
                        
                        <div class="recommendation-actions">
                            <a href="explorar-detalhe.html?id=${op.idoportunidade}" class="btn-detalhes-home">
                                Ver detalhes
                            </a>
                            <button onclick="inscreverHome(${op.idoportunidade}, this)" class="btn-inscrever-home">
                                <i class="fa-regular fa-heart"></i> Inscreva-se
                            </button>
                        </div>
                    `;
                    lista.appendChild(item);
                });
            } catch (error) {
                console.error("Erro ao carregar recomenda√ß√µes:", error);
            }
        });

        // Fun√ß√£o Auxiliar: Sauda√ß√£o do Header
        function atualizarSaudacao() {
            const userJson = localStorage.getItem('userData');
            if (userJson) {
                const user = JSON.parse(userJson);
                document.getElementById('header-greeting').innerHTML = `Ol√°, ${user.nome}! <span class="wave-emoji">üëã</span>`;
            }
        }

        /**
         * Fun√ß√£o de Inscri√ß√£o com Feedback Visual
         * @param {number} id - ID da oportunidade
         * @param {HTMLElement} btnElement - O bot√£o que foi clicado (para alterar estilo)
         */
        async function inscreverHome(id, btnElement) {
            // Valida√ß√£o de Login
            const userJson = localStorage.getItem('userData');
            if (!userJson) { alert("Fa√ßa login para se inscrever!"); window.location.href = "login.html"; return; }
            const user = JSON.parse(userJson);

            if (confirm("Deseja se inscrever nesta oportunidade?")) {
                try {
                    const response = await fetch('/api/inscricao', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuario_cpf: user.cpf, oportunidade_id: id })
                    });
                    const res = await response.json();
                    
                    if (response.ok) { 
                        // SUCESSO: Altera o visual do bot√£o para "Inscrito"
                        btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Inscrito';
                        btnElement.className = 'btn-inscrito'; // Classe definida no CSS para estilo verde/slim
                        btnElement.style.width = '100%';       
                        btnElement.disabled = true;            // Bloqueia novos cliques
                        
                        // Atualiza os outros widgets da p√°gina em tempo real
                        carregarMinhasAtividades(); 
                        carregarEstatisticas();
                    } 
                    else { alert(res.message); } // Ex: "J√° inscrito"
                } catch (e) { console.error(e); alert("Erro de conex√£o."); }
            }
        }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        carregarMinhasAtividades();
    });

    async function carregarMinhasAtividades() {
        const userJson = localStorage.getItem('userData');
        if (!userJson) return; 
        const user = JSON.parse(userJson);

        const lista = document.getElementById('lista-minhas-atividades');
        const emptyState = document.getElementById('empty-state-atividades');

        try {
            const response = await fetch(`/api/minhas-atividades/${user.cpf}`);
            const inscricoes = await response.json();

            if (inscricoes.length === 0) {
                lista.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            lista.style.display = 'block';
            lista.innerHTML = ''; 

            inscricoes.forEach(item => {
                const op = item.oportunidade; 
                const li = document.createElement('li');
                li.className = 'recommendation-item';

                const dataObj = new Date(op.data_evento);
                const dataUser = new Date(dataObj.getTime() + dataObj.getTimezoneOffset() * 60000);
                const dataFormatada = dataUser.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });

                let tagClass = 'tag-blue';
                const tipo = op.tipo_voluntariado ? op.tipo_voluntariado.tipo : 'Geral';

                li.innerHTML = `
                    <div class="item-details">
                        <h3>${op.titulo}</h3>
                        <span class="tag ${tagClass}" style="font-size: 11px;">${tipo}</span>
                        <div class="item-info" style="margin-top: 8px;">
                            <span><i class="fa-regular fa-calendar-days"></i> ${dataFormatada}</span>
                            <span><i class="fa-regular fa-clock"></i> ${op.horario}</span>
                        </div>
                    </div>
                    <div class="recommendation-actions" style="min-width: 120px;">
                        <a href="explorar-detalhe.html?id=${op.idoportunidade}" class="btn-detalhes-home" style="font-size: 12px; padding: 6px;">Detalhes</a>
                        <button onclick="cancelarInscricao(${op.idoportunidade})" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #dc3545; background: #fff; color: #dc3545; cursor: pointer; font-weight: 600; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 5px;"><i class="fa-solid fa-xmark"></i> Cancelar</button>
                    </div>
                `;
                lista.appendChild(li);
            });
        } catch (error) {
            console.error("Erro ao carregar minhas atividades:", error);
        }
    }

    // Fun√ß√£o para Cancelar Inscri√ß√£o (DELETE)
    async function cancelarInscricao(idOportunidade) {
        const userJson = localStorage.getItem('userData');
        if (!userJson) return;
        const user = JSON.parse(userJson);

        if (confirm("Tem certeza que deseja cancelar sua inscri√ß√£o nesta atividade?")) {
            try {
                const response = await fetch('/api/inscricao', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        usuario_cpf: user.cpf, 
                        oportunidade_id: idOportunidade 
                    })
                });
                const resultado = await response.json();
                if (response.ok) {
                    alert("Inscri√ß√£o cancelada.");
                    carregarMinhasAtividades(); // Recarrega lista
                    carregarEstatisticas();     // Atualiza contadores
                } else {
                    alert("Erro: " + resultado.message);
                }
            } catch (error) { console.error(error); alert("Erro de conex√£o."); }
        }
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        carregarTestemunhosHome();
    });

    async function carregarTestemunhosHome() {
        try {
            const userJson = localStorage.getItem('userData');
            const user = userJson ? JSON.parse(userJson) : null;

            const response = await fetch('/api/testemunhos');
            const lista = await response.json();
            
            const container = document.getElementById('lista-testemunhos-home');
            const emptyState = document.getElementById('empty-state-testemunhos');

            const recentes = lista.slice(0, 2); // Mostra apenas os 2 √∫ltimos

            if (recentes.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.style.display = 'flex'; 
            container.innerHTML = '';

            recentes.forEach(t => {
                const div = document.createElement('div');
                div.className = 'testimonial-card'; 
                div.style.padding = '15px'; 
                div.style.border = '1px solid #f0f0f0';
                div.style.boxShadow = 'none'; 

                const nomeUser = t.usuario ? t.usuario.nomeUsuario : 'An√¥nimo';
                const inicial = nomeUser.charAt(0).toUpperCase();
                
                // Valida√ß√£o de Dono: S√≥ mostra bot√£o Excluir se CPFs baterem
                let btnExcluirHTML = '';
                if (user && t.usuario_cpf === user.cpf) {
                    btnExcluirHTML = `
                        <button onclick="excluirTestemunho(${t.idtestemunhos}, 'home')" 
                                style="margin-top:10px; width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #dc3545; background: #fff; color: #dc3545; cursor: pointer; font-weight: 600; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fa-regular fa-trash-can"></i> Excluir meu depoimento
                        </button>
                    `;
                }
                
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <div class="testimonial-avatar" style="width:30px; height:30px; font-size:12px;">${inicial}</div>
                        <strong style="font-size:13px; color:#333;">${nomeUser}</strong>
                    </div>
                    <p style="font-size:13px; color:#666; margin:0; font-style:italic; line-height: 1.4;">"${t.texto}"</p>
                    <small style="color:#007bff; font-size:11px; margin-top:8px; display:block; font-weight:500;">Em: ${t.oportunidade ? t.oportunidade.titulo : 'Atividade'}</small>
                    ${btnExcluirHTML}
                `;
                container.appendChild(div);
            });

        } catch (error) {
            console.error("Erro ao carregar testemunhos home:", error);
        }
    }

    async function excluirTestemunho(id, origem) {
        const userJson = localStorage.getItem('userData');
        if (!userJson) return;
        const user = JSON.parse(userJson);

        if (confirm("Tem certeza que deseja apagar este depoimento?")) {
            try {
                const res = await fetch(`/api/testemunhos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario_cpf: user.cpf })
                });
                
                if (res.ok) {
                    alert("Depoimento exclu√≠do.");
                    if (origem === 'home') carregarTestemunhosHome();
                } else {
                    const json = await res.json();
                    alert("Erro: " + json.message);
                }
            } catch (e) { console.error(e); alert("Erro de conex√£o."); }
        }
    }
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        carregarEstatisticas();
    });

    async function carregarEstatisticas() {
        const userJson = localStorage.getItem('userData');
        if (!userJson) return;
        const user = JSON.parse(userJson);

        try {
            const response = await fetch(`/api/estatisticas/${user.cpf}`);
            const dados = await response.json();

            // Atualiza Painel Superior (IDs est√°ticos)
            document.getElementById('stat-oportunidades').textContent = dados.totalOportunidades;
            document.getElementById('stat-horas').textContent = dados.minhasHoras + 'h';
            document.getElementById('stat-proximas').textContent = dados.proximasAtividades;
            document.getElementById('stat-total-geral').textContent = dados.totalVoluntariados;

            // Atualiza Card Lateral (Seu Impacto)
            document.getElementById('impact-horas-valor').textContent = dados.minhasHoras;
            document.getElementById('impact-concluidas').textContent = dados.atividadesConcluidas;
            document.getElementById('impact-proximas').textContent = dados.proximasAtividades;

        } catch (error) {
            console.error("Erro ao carregar estat√≠sticas:", error);
        }
    }
    </script>

</body>
</html>