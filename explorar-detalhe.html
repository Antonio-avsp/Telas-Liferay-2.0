<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="detalhe-titulo-pagina">Detalhe da Oportunidade</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fa-regular fa-heart"></i>
                </div>
                <span>Voluntariado<br><strong>Liferay</strong></span>
            </div>
            <nav class="navigation">
                <p>Navegação</p>
                <ul>
                    <li><a href="inicio.html"><i class="fa-solid fa-house"></i> Início</a></li>
                    <li><a href="explorar.html" class="active"><i class="fa-solid fa-magnifying-glass"></i> Explorar</a></li>
                    <li><a href="criar-oportunidade.html"><i class="fa-solid fa-circle-plus"></i> Criar Oportunidade</a></li>
                    <li><a href="impacto.html"><i class="fa-solid fa-chart-line"></i> Impacto</a></li>
                    <li><a href="testemunhos.html"><i class="fa-solid fa-comments"></i> Testemunhos</a></li>
                    <li><a href="MeuPerfil.html"><i class="fa-solid fa-user"></i> Meu perfil</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="MeuPerfil.html" class="user-info-link">
                    <div class="user-info">
                        <div class="avatar-small">...</div>
                        <div class="user-details">
                            <strong>Carregando...</strong>
                            <span id="sidebar-horas">0h de voluntariado</span>
                        </div>
                    </div>
                </a>
                
                <button class="logout-button">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">

            <header class="detail-page-header">
                <a href="explorar.html" class="back-link">
                    <i class="fa-solid fa-arrow-left"></i> Voltar
                </a>
                
                <button class="create-opportunity-btn-header" style="background-color: #d9534f; display: none;">
                    <i class="fa-solid fa-trash"></i> Excluir Oportunidade
                </button>
            </header>

            <div class="detail-banner-image">
                <img src="" alt="Banner da oportunidade" id="detalhe-imagem" style="display: none; width: 100%; height: 100%; object-fit: cover;">
            </div>

            <div class="detail-layout">

                <div class="detail-main-column">
                    <header class="detail-content-header">
                        <div>
                            <span class="tag tag-blue" id="detalhe-tag">Carregando...</span>
                            <h2 id="detalhe-titulo">Carregando título...</h2>
                        </div>
                        <button class="share-button">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                    </header>

                    <section class="detail-info-boxes">
                        <div class="info-box">
                            <i class="fa-regular fa-calendar-days"></i>
                            <span>Data</span>
                            <strong id="detalhe-data">--</strong>
                        </div>
                        <div class="info-box">
                            <i class="fa-regular fa-clock"></i>
                            <span>Horário</span>
                            <strong id="detalhe-horario">--</strong>
                        </div>
                        <div class="info-box">
                            <i class="fa-solid fa-location-dot"></i>
                            <span>Local</span>
                            <strong id="detalhe-local">--</strong>
                        </div>
                        <div class="info-box">
                            <i class="fa-solid fa-users"></i>
                            <span>Vagas</span>
                            <strong id="detalhe-inscritos">--</strong>
                        </div>
                    </section>

                    <section class="detail-section">
                        <h3><i class="fa-solid fa-star"></i> Sobre a oportunidade</h3>
                        <p id="detalhe-descricao">...</p>
                    </section>

                    <section class="detail-section">
                        <h3>Habilidades Desejadas</h3>
                        <div class="tag-list" id="detalhe-habilidades">
                            </div>
                    </section>

                    <section class="detail-section detail-testimonials">
                        <div class="testimonial-header">
                            <h3>Testemunhos</h3>
                        </div>
                        <div class="empty-testimonial">
                            <i class="fa-regular fa-comments"></i>
                            <span id="detalhe-testemunhos-msg">Os testemunhos desta atividade aparecerão aqui.</span>
                        </div>
                    </section>
                </div>

                <aside class="detail-sidebar-column">
                    <div class="action-card">
                        <h4>Participe desta oportunidade</h4>
                        <p>Faça a diferença e contribua para uma causa importante</p>
                        <button class="btn-inscricao" id="btn-inscrever-detalhe">
                            <i class="fa-regular fa-heart"></i> Inscrever-se
                        </button>
                    </div>

                    <div class="action-card">
                        <h4>Organização</h4>
                        <p id="detalhe-org-nome">Nome da Organização</p>
                        <small><i class="fa-regular fa-envelope"></i> <span id="detalhe-org-email">...</span></small>
                    </div>
                </aside>

            </div> 
        </main>
    </div>
    
    <script src="app.js"></script>

   <script>
    document.addEventListener('DOMContentLoaded', async () => {

        const btnExcluir = document.querySelector('.create-opportunity-btn-header');
        const btnInscrever = document.getElementById('btn-inscrever-detalhe'); // Referência ao botão

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        let dadosFinais = null;

        try {
            if (!id) throw new Error("ID não fornecido");

            const userJson = localStorage.getItem('userData');
            const user = userJson ? JSON.parse(userJson) : null;

            // 1. BUSCA DETALHES DA OPORTUNIDADE
            const response = await fetch(`/api/oportunidades/${id}`);
            if (!response.ok) throw new Error('Oportunidade não encontrada');
            const dbData = await response.json();
            
            // (Preenchimento dos dados na tela igual ao anterior...)
            dadosFinais = {
                id: dbData.idoportunidade, 
                usuario_cpf_criador: dbData.usuario_cpf_criador, 
                titulo: dbData.titulo,
                tag: dbData.tipo_voluntariado ? dbData.tipo_voluntariado.tipo : 'Geral',
                tagClass: 'tag-blue',
                imagem: dbData.imagem_url || 'images/default.jpg',
                data: dbData.data_evento,
                horario: dbData.horario,
                local: dbData.local_evento,
                vagas: dbData.num_vagas,
                descricao: dbData.descricao,
                habilidades: dbData.habilidades_desejadas ? dbData.habilidades_desejadas.split(',') : [],
                orgNome: dbData.instituicao ? dbData.instituicao.nomeInstituicao : 'Organização',
                orgEmail: dbData.instituicao ? dbData.instituicao.email_contato : '---',
                isStatic: false 
            };

            // --- 2. VERIFICA SE JÁ ESTÁ INSCRITO ---
            if (user) {
                try {
                    const resIns = await fetch(`/api/minhas-atividades/${user.cpf}`);
                    const minhasInscricoes = await resIns.json();
                    // Verifica se este ID está na lista
                    const jaInscrito = minhasInscricoes.some(i => i.oportunidade_idoportunidade == id);

                    if (jaInscrito && btnInscrever) {
                        btnInscrever.innerHTML = '<i class="fa-solid fa-check"></i> Inscrito';
                        btnInscrever.className = 'btn-inscrito'; 
                        btnInscrever.style.backgroundColor = 'transparent'; // Remove fundo azul
                        btnInscrever.style.color = '#28a745';
                        btnInscrever.style.width = '100%';
                        btnInscrever.disabled = true;
                    }
                } catch (e) { console.error("Erro ao checar inscrição", e); }
            }

            // --- 3. LÓGICA DE EXIBIR BOTÃO EXCLUIR ---
            if (user && dadosFinais.usuario_cpf_criador == user.cpf) {
                if (btnExcluir) {
                    btnExcluir.style.display = 'flex';
                    btnExcluir.onclick = async () => {
                        if (confirm("Tem certeza que deseja EXCLUIR esta oportunidade?")) {
                            try {
                                const resDel = await fetch(`/api/oportunidades/${dadosFinais.id}`, {
                                    method: 'DELETE',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ usuario_cpf: user.cpf }) 
                                });
                                if (resDel.ok) { alert("Excluída!"); window.location.href = 'explorar.html'; }
                                else { const j = await resDel.json(); alert(j.message); }
                            } catch (err) { console.error(err); alert("Erro conexão."); }
                        }
                    };
                }
            }

            // --- RENDERIZAÇÃO (TEXTOS E IMAGEM) ---
            document.getElementById('detalhe-titulo-pagina').textContent = dadosFinais.titulo;
            
            const imgElement = document.getElementById('detalhe-imagem');
            imgElement.src = dadosFinais.imagem;
            imgElement.style.display = 'block'; 

            const tagElement = document.getElementById('detalhe-tag');
            tagElement.textContent = dadosFinais.tag;
            tagElement.className = `tag ${dadosFinais.tagClass}`;
            
            document.getElementById('detalhe-titulo').textContent = dadosFinais.titulo;
            
            const dataObj = new Date(dadosFinais.data);
            const dataUser = new Date(dataObj.getTime() + dataObj.getTimezoneOffset() * 60000);
            document.getElementById('detalhe-data').textContent = dataUser.toLocaleDateString('pt-BR');
            document.getElementById('detalhe-horario').textContent = dadosFinais.horario;
            document.getElementById('detalhe-local').textContent = dadosFinais.local;
            document.getElementById('detalhe-inscritos').textContent = `${dadosFinais.vagas}`;
            document.getElementById('detalhe-descricao').textContent = dadosFinais.descricao;

            const habContainer = document.getElementById('detalhe-habilidades');
            habContainer.innerHTML = '';
            dadosFinais.habilidades.forEach(h => {
                const span = document.createElement('span');
                span.className = 'skill-tag'; 
                span.textContent = h.trim();
                habContainer.appendChild(span);
            });

            document.getElementById('detalhe-org-nome').textContent = dadosFinais.orgNome;
            document.getElementById('detalhe-org-email').textContent = dadosFinais.orgEmail;

        } catch (error) {
            console.error(error);
            alert("Erro: " + error.message);
            window.location.href = 'explorar.html';
        }

        // --- EVENTO DE CLIQUE DO BOTÃO INSCREVER ---
        if (btnInscrever) {
            btnInscrever.addEventListener('click', async () => {
                const userJson = localStorage.getItem('userData');
                if (!userJson) { alert("Faça login!"); window.location.href = "login.html"; return; }
                const user = JSON.parse(userJson);

                if(confirm("Deseja confirmar sua inscrição?")) {
                    try {
                        const resp = await fetch('/api/inscricao', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ usuario_cpf: user.cpf, oportunidade_id: id })
                        });
                        const res = await resp.json();
                        if (resp.ok) {
                            // ATUALIZA O BOTÃO IMEDIATAMENTE
                            btnInscrever.innerHTML = '<i class="fa-solid fa-check"></i> Inscrito';
                            btnInscrever.className = 'btn-inscrito'; 
                            btnInscrever.style.backgroundColor = 'transparent';
                            btnInscrever.style.color = '#28a745';
                            btnInscrever.disabled = true;
                            alert("Inscrito com sucesso!");
                        } else {
                            alert(res.message);
                        }
                    } catch (e) { console.error(e); alert("Erro de conexão"); }
                }
            });
        }
    });
    </script>
</body>
</html>