<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testemunhos</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="testemunhos-body">

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon"><i class="fa-regular fa-heart"></i></div>
                <span>Voluntariado<br><strong>Liferay</strong></span>
            </div>
            <nav class="navigation">
                <p>Navegação</p>
                <ul>
                    <li><a href="inicio.html"><i class="fa-solid fa-house"></i> Início</a></li>
                    <li><a href="explorar.html"><i class="fa-solid fa-magnifying-glass"></i> Explorar</a></li>
                    <li><a href="criar-oportunidade.html"><i class="fa-solid fa-circle-plus"></i> Criar Oportunidade</a></li>
                    <li><a href="impacto.html"><i class="fa-solid fa-chart-line"></i> Impacto</a></li>
                    <li><a href="testemunhos.html" class="active"><i class="fa-solid fa-comments"></i> Testemunhos</a></li>
                    <li><a href="MeuPerfil.html"><i class="fa-solid fa-user"></i> Meu perfil</a></li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <a href="MeuPerfil.html" class="user-info-link">
                    <div class="user-info">
                        <div class="avatar-small">...</div>
                        <div class="user-details">
                            <strong>Carregando...</strong>
                            <span id="sidebar-horas">0h de voluntariado</span>
                        </div>
                    </div>
                </a>
                
                <button class="logout-button">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="page-header">
                <div>
                    <h1>Histórias que inspiram</h1>
                    <p>Veja o que nossa comunidade está construindo</p>
                </div>
                <button class="create-opportunity-btn" id="btn-abrir-modal">
                    <i class="fa-regular fa-pen-to-square"></i> Deixar meu depoimento
                </button>
            </div>

            <div class="testemunhos-filter-bar">
                <div class="testemunhos-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="input-busca" placeholder="Buscar por palavra-chave ou nome...">
                </div>
            </div>

            <section class="testimonials-grid" id="grid-testemunhos">
                <div class="testemunhos-empty-state">
                    <i class="fa-regular fa-comment-dots empty-icon"></i>
                    <p>Carregando histórias...</p>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="modal-testemunho">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Escrever Depoimento</h2>
                <button class="close-modal-btn" id="btn-fechar-modal">&times;</button>
            </div>
            
            <form id="form-testemunho">
                <label for="select-oportunidade-modal" style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Sobre qual oportunidade?</label>
                
                <select id="select-oportunidade-modal" required>
                    <option value="" disabled selected>Carregando suas participações...</option>
                </select>

                <label for="texto-depoimento" style="display:block; margin-bottom:5px; font-weight:600; color:#555;">Seu depoimento</label>
                <textarea id="texto-depoimento" rows="5" class="form-row" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; resize:vertical;" placeholder="Conte como foi sua experiência..." required></textarea>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btn-cancelar-modal">Cancelar</button>
                    <button type="submit" class="btn-submit">Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    
   <script>
        // =================================================================
        // VARIÁVEIS GLOBAIS DE CONTROLE
        // =================================================================
        let modoEdicao = false; // Define se o modal vai Criar (POST) ou Editar (PUT)
        let idEdicao = null;    // Guarda o ID do item sendo editado
        let todosTestemunhos = []; // Guarda a lista completa para busca local

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarTestemunhos();
            configurarModal();
            configurarBusca();
        });

        // =================================================================
        // FUNÇÃO 1: CARREGAR LISTA (GET)
        // Busca todos os testemunhos e salva na memória.
        // =================================================================
        async function carregarTestemunhos() {
            try {
                const response = await fetch('/api/testemunhos');
                const lista = await response.json();
                
                // Salva globalmente (Importante para a edição funcionar sem erros de aspas)
                window.todosTestemunhos = lista; 
                
                renderizarLista(lista);

            } catch (error) {
                console.error(error);
                const grid = document.getElementById('grid-testemunhos');
                grid.innerHTML = '<p class="error-text">Erro ao carregar histórias.</p>';
            }
        }

        // =================================================================
        // FUNÇÃO 2: RENDERIZAR CARDS
        // Cria o HTML de cada card.
        // =================================================================
        function renderizarLista(lista) {
            const grid = document.getElementById('grid-testemunhos');
            const userJson = localStorage.getItem('userData');
            const user = userJson ? JSON.parse(userJson) : null;

            grid.innerHTML = '';

            if (lista.length === 0) {
                grid.innerHTML = '<div class="testemunhos-empty-state"><p>Nenhum testemunho encontrado.</p></div>';
                return;
            }

            lista.forEach(t => {
                const card = document.createElement('div');
                card.className = 'testimonial-card';
                
                const dataFormatada = new Date(t.data).toLocaleDateString('pt-BR');
                const inicial = t.usuario ? t.usuario.nomeUsuario.charAt(0).toUpperCase() : '?';
                const nomeUser = t.usuario ? t.usuario.nomeUsuario : 'Usuário';
                const nomeOpp = t.oportunidade ? t.oportunidade.titulo : 'Atividade Geral';

                // --- LÓGICA DE BOTÕES (SEGURANÇA VISUAL) ---
                // Só mostra Editar/Excluir se o usuário logado for o autor
                let acoesHTML = '';
                if (user && t.usuario_cpf === user.cpf) {
                    // CORREÇÃO DO BUG: Passamos APENAS o ID. O JS busca o texto na memória depois.
                    // Isso evita que aspas ou enters quebrem o HTML.
                    acoesHTML = `
                        <div style="margin-top: auto; align-self: flex-end; display: flex; gap: 15px;">
                            <button onclick="abrirModalEdicao(${t.idtestemunhos})" 
                                    style="background: none; border: none; color: #007bff; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                                <i class="fa-regular fa-pen-to-square"></i> Editar
                            </button>
                            <button onclick="excluirTestemunho(${t.idtestemunhos})" 
                                    style="background: none; border: none; color: #dc3545; font-size: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                                <i class="fa-regular fa-trash-can"></i> Excluir
                            </button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="testimonial-header-content">
                        <div class="testimonial-avatar">${inicial}</div>
                        <div class="testimonial-info">
                            <h4>${nomeUser}</h4>
                            <span>${dataFormatada}</span>
                        </div>
                    </div>
                    <div class="testimonial-body">${t.texto}</div>
                    <div style="margin-top: 10px; margin-bottom: 10px;">
                        <a href="explorar-detalhe.html?id=${t.oportunidade_idoportunidade}" class="testimonial-tag">
                            <i class="fa-solid fa-link"></i> ${nomeOpp}
                        </a>
                    </div>
                    ${acoesHTML}
                `;
                grid.appendChild(card);
            });
        }

        // =================================================================
        // FUNÇÃO 3: ABRIR MODAL PARA EDIÇÃO (CORRIGIDA)
        // Busca o objeto na memória pelo ID para evitar erros de caracteres.
        // =================================================================
        window.abrirModalEdicao = function(id) {
            // Busca o item na lista global
            const item = window.todosTestemunhos.find(t => t.idtestemunhos === id);
            if (!item) return; // Segurança

            modoEdicao = true;
            idEdicao = id;
            
            const modal = document.getElementById('modal-testemunho');
            const tituloModal = document.querySelector('.modal-header h2');
            const btnSubmit = document.querySelector('.modal-actions .btn-submit');
            const textarea = document.getElementById('texto-depoimento');

            // Ajusta textos visuais
            tituloModal.textContent = "Editar Depoimento";
            btnSubmit.textContent = "Salvar Alterações";
            
            // Preenche o campo de texto com o dado seguro da memória
            textarea.value = item.texto;
            
            // Carrega o select e seleciona a oportunidade correta
            carregarOpcoesSelect(item.oportunidade_idoportunidade);
            
            modal.style.display = 'flex';
        };

        // =================================================================
        // FUNÇÃO 4: CARREGAR SELECT (Minhas Atividades)
        // Preenche o dropdown do modal.
        // =================================================================
        async function carregarOpcoesSelect(idPreSelecionado = null) {
            const user = JSON.parse(localStorage.getItem('userData'));
            const select = document.getElementById('select-oportunidade-modal');
            select.innerHTML = '<option>Carregando...</option>';

            try {
                const resp = await fetch(`/api/minhas-atividades/${user.cpf}`);
                const inscricoes = await resp.json();
                
                select.innerHTML = '<option value="" disabled selected>Selecione uma oportunidade...</option>';
                
                if (inscricoes.length === 0) {
                    const opt = document.createElement('option');
                    opt.disabled = true;
                    opt.text = "Você não participou de atividades recentes.";
                    select.appendChild(opt);
                } else {
                    inscricoes.forEach(ins => {
                        const opt = document.createElement('option');
                        opt.value = ins.oportunidade.idoportunidade;
                        opt.text = ins.oportunidade.titulo;
                        
                        // Se estiver editando, seleciona a opção certa
                        if (idPreSelecionado && idPreSelecionado === ins.oportunidade.idoportunidade) {
                            opt.selected = true;
                        }
                        select.appendChild(opt);
                    });
                }
                
                // Na edição, bloqueamos a troca de oportunidade (regra de negócio)
                if (modoEdicao) select.disabled = true;
                else select.disabled = false;

            } catch (e) { console.error(e); select.innerHTML = '<option>Erro ao carregar</option>'; }
        }

        // =================================================================
        // FUNÇÃO 5: EXCLUIR (DELETE)
        // =================================================================
        window.excluirTestemunho = async function(id) {
             const userJson = localStorage.getItem('userData');
             if (!userJson) return;
             const user = JSON.parse(userJson);

             if (confirm("Tem certeza que deseja apagar este depoimento?")) {
                 try {
                     const res = await fetch(`/api/testemunhos/${id}`, {
                         method: 'DELETE',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ usuario_cpf: user.cpf })
                     });
                     if (res.ok) {
                         alert("Depoimento excluído.");
                         carregarTestemunhos();
                     } else { 
                         const json = await res.json();
                         alert("Erro: " + json.message); 
                     }
                 } catch (e) { console.error(e); }
             }
        }

        // =================================================================
        // FUNÇÃO 6: FILTRO (BUSCA)
        // =================================================================
        function configurarBusca() {
            const input = document.getElementById('input-busca');
            input.addEventListener('input', (e) => {
                const termo = e.target.value.toLowerCase();
                
                const filtrados = window.todosTestemunhos.filter(t => {
                    const texto = t.texto.toLowerCase();
                    const nome = t.usuario ? t.usuario.nomeUsuario.toLowerCase() : '';
                    return texto.includes(termo) || nome.includes(termo);
                });
                
                renderizarLista(filtrados);
            });
        }

        // =================================================================
        // FUNÇÃO 7: CONFIGURAÇÃO GERAL DO MODAL (Abrir/Fechar/Salvar)
        // =================================================================
        function configurarModal() {
            const modal = document.getElementById('modal-testemunho');
            const btnAbrir = document.getElementById('btn-abrir-modal');
            const btnFechar = document.getElementById('btn-fechar-modal');
            const btnCancelar = document.getElementById('btn-cancelar-modal');
            const form = document.getElementById('form-testemunho');
            const select = document.getElementById('select-oportunidade-modal');

            // Botão "Criar Novo"
            btnAbrir.addEventListener('click', () => {
                const userJson = localStorage.getItem('userData');
                if (!userJson) { alert("Faça login."); window.location.href='login.html'; return; }
                
                // Reseta para modo Criação
                modoEdicao = false;
                idEdicao = null;
                document.querySelector('.modal-header h2').textContent = "Escrever Depoimento";
                document.querySelector('.modal-actions .btn-submit').textContent = "Publicar";
                document.getElementById('texto-depoimento').value = "";
                select.value = "";
                
                carregarOpcoesSelect();
                modal.style.display = 'flex';
            });

            const fechar = () => modal.style.display = 'none';
            btnFechar.addEventListener('click', fechar);
            btnCancelar.addEventListener('click', fechar);

            // Submit do Formulário (Gerencia Criação e Edição)
            // Envio do Formulário
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = JSON.parse(localStorage.getItem('userData'));
                const select = document.getElementById('select-oportunidade-modal');
                
                // --- CORREÇÃO DE SEGURANÇA AQUI ---
                // Se o valor for vazio (usuário não selecionou ou não tem atividades), PARA TUDO.
                if (!select.value || select.value === "") {
                    alert("Você precisa selecionar uma atividade para avaliar.\nSe a lista está vazia, inscreva-se em uma oportunidade primeiro!");
                    return; // Impede o envio para o servidor
                }
                // ----------------------------------

                const dados = {
                    usuario_cpf: user.cpf,
                    oportunidade_id: select.value,
                    texto: document.getElementById('texto-depoimento').value
                };

                // Define rota e método dinamicamente
                let url = '/api/testemunhos';
                let metodo = 'POST';

                if (modoEdicao) {
                    url = `/api/testemunhos/${idEdicao}`;
                    metodo = 'PUT';
                }

                try {
                    const res = await fetch(url, {
                        method: metodo,
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(dados)
                    });
                    
                    // Verifica se a resposta foi OK antes de tentar ler o JSON
                    if (!res.ok) {
                        throw new Error(`Erro do servidor: ${res.status}`);
                    }

                    const json = await res.json();
                    
                    if (res.ok) {
                        alert(modoEdicao ? "Atualizado com sucesso!" : "Enviado com sucesso!");
                        fechar();
                        form.reset();
                        carregarTestemunhos();
                    } else {
                        alert(json.message);
                    }
                } catch (err) { 
                    console.error("Detalhes do erro:", err); 
                    alert("Ocorreu um erro ao enviar. Verifique se você selecionou uma atividade válida."); 
                }
            });
        }
    </script>
</body>
</html>