<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorar</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fa-regular fa-heart"></i>
                </div>
                <span>Voluntariado<br><strong>Liferay</strong></span>
            </div>

            <nav class="navigation">
                <p>Navegação</p>
                <ul>
                    <li><a href="inicio.html"><i class="fa-solid fa-house"></i> Início</a></li>
                    <li><a href="explorar.html" class="active"><i class="fa-solid fa-magnifying-glass"></i> Explorar</a></li>
                    <li><a href="criar-oportunidade.html"><i class="fa-solid fa-circle-plus"></i> Criar Oportunidade</a></li>
                    <li><a href="impacto.html"><i class="fa-solid fa-chart-line"></i> Impacto</a></li>
                    <li><a href="testemunhos.html"><i class="fa-solid fa-comments"></i> Testemunhos</a></li>
                    <li><a href="MeuPerfil.html"><i class="fa-solid fa-user"></i> Meu perfil</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="MeuPerfil.html" class="user-info-link">
                    <div class="user-info">
                        <div class="avatar-small">...</div>
                        <div class="user-details">
                            <strong>Carregando...</strong>
                            <span id="sidebar-horas">0h de voluntariado</span>
                        </div>
                    </div>
                </a>
                
                <button class="logout-button">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="explore-header">
                <h1>Explorar Oportunidades</h1>
                <p>Encontre a causa perfeita para você</p>
            </div>

            <div class="filter-bar">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Buscar por título, descrição ou organização...">
                </div>
                <button class="filter-button">
                    <i class="fa-solid fa-filter"></i>
                    Filtrar
                </button>
            </div>

            <section class="opportunity-grid" id="grid-oportunidades">
                <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #777;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 30px; color: #007bff; margin-bottom: 15px;"></i>
                    <p>Buscando oportunidades disponíveis...</p>
                </div>
            </section>

        </main>
    </div>
    
    <script src="app.js"></script>

    <script>
        let todasOportunidades = [];
        let idsInscritosGlobal = []; // Variável para guardar onde o usuário está inscrito

        document.addEventListener('DOMContentLoaded', carregarDadosIniciais);

        const searchInput = document.querySelector('.search-box input');
        searchInput.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            filtrarOportunidades(termo);
        });

        // 1. CARREGAR DADOS (Oportunidades + Inscrições do Usuário)
        async function carregarDadosIniciais() {
            try {
                // A. Busca Oportunidades
                const resOps = await fetch('/api/oportunidades');
                if (!resOps.ok) throw new Error("Falha ao buscar dados");
                todasOportunidades = await resOps.json();

                // B. Busca Inscrições do Usuário (se logado)
                const userJson = localStorage.getItem('userData');
                if (userJson) {
                    const user = JSON.parse(userJson);
                    try {
                        const resIns = await fetch(`/api/minhas-atividades/${user.cpf}`);
                        const dadosIns = await resIns.json();
                        idsInscritosGlobal = dadosIns.map(i => i.oportunidade_idoportunidade);
                    } catch (e) { console.error("Erro ao buscar inscrições", e); }
                }
                
                renderizarGrid(todasOportunidades);

            } catch (error) { 
                console.error("Erro:", error); 
                document.getElementById('grid-oportunidades').innerHTML = '<p style="text-align:center;">Erro ao carregar.</p>';
            }
        }

        function filtrarOportunidades(termo) {
            const filtradas = todasOportunidades.filter(op => {
                const titulo = op.titulo.toLowerCase();
                const ong = op.instituicao ? op.instituicao.nomeInstituicao.toLowerCase() : '';
                return titulo.includes(termo) || ong.includes(termo);
            });
            renderizarGrid(filtradas);
        }

        // 3. RENDERIZAR GRID (Com verificação de inscrito)
        function renderizarGrid(lista) {
            const grid = document.getElementById('grid-oportunidades');
            grid.innerHTML = ''; 

            if (lista.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #777;">Nenhuma oportunidade encontrada.</p>';
                return;
            }

            const isNovo = (index) => index < 5; 

            lista.forEach((op, index) => {
                const card = document.createElement('div');
                card.className = 'opportunity-card';
                
                const dataObj = new Date(op.data_evento);
                const dataUser = new Date(dataObj.getTime() + dataObj.getTimezoneOffset() * 60000);
                const dataFormatada = dataUser.toLocaleDateString('pt-BR');
                const nomeOng = op.instituicao ? op.instituicao.nomeInstituicao : 'Organização';

                let tagClass = 'tag-blue';
                const tipo = op.tipo_voluntariado ? op.tipo_voluntariado.tipo : 'Geral';
                const mapTipos = { 'Meio Ambiente': 'tag-green', 'Educação': 'tag-purple', 'Saúde': 'tag-red', 'Cultura': 'tag-red', 'Assistência Social': 'tag-yellow' };
                if(mapTipos[tipo]) tagClass = mapTipos[tipo];

                const htmlNovo = isNovo(index) ? '<span class="tag-novo" style="margin-right:5px; background: #d3e6fa; color:#007bff; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:700;">Novo</span>' : '';
                const imagemFinal = op.imagem_url ? op.imagem_url : 'https://placehold.co/600x400?text=Sem+Imagem';

                // VERIFICAÇÃO: O usuário já está inscrito nesta oportunidade?
                const jaInscrito = idsInscritosGlobal.includes(op.idoportunidade);
                
                let btnHTML = '';
                if (jaInscrito) {
                    btnHTML = `
                        <button class="btn-inscrito" style="width: 100%; margin-top: 10px;" disabled>
                            <i class="fa-solid fa-check"></i> Inscrito
                        </button>
                    `;
                } else {
                    btnHTML = `
                        <button onclick="inscreverDinamicamente(${op.idoportunidade}, this)" class="inscricao-btn-explorar">
                            <i class="fa-regular fa-heart"></i> Inscreva-se
                        </button>
                    `;
                }

                card.innerHTML = `
                    <img src="${imagemFinal}" alt="${op.titulo}" onerror="this.src='https://placehold.co/600x400?text=Erro+Imagem'">
                    <div class="card-content">
                        <div>
                            ${htmlNovo}
                            <span class="tag ${tagClass}">${tipo}</span>
                        </div>
                        <h3>${op.titulo}</h3>
                        <p>${op.descricao ? op.descricao.substring(0, 100) + '...' : ''}</p>
                        
                        <div class="card-info">
                            <span><i class="fa-solid fa-building"></i> ${nomeOng}</span>
                            <span><i class="fa-solid fa-location-dot"></i> ${op.local_evento.split(',')[0]}</span>
                            <span><i class="fa-solid fa-calendar-days"></i> ${dataFormatada}</span>
                            <span><i class="fa-regular fa-clock"></i> ${op.horario}</span>
                        </div>

                        <a href="explorar-detalhe.html?id=${op.idoportunidade}" class="details-button">Ver detalhes</a>
                        ${btnHTML}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function inscreverDinamicamente(id, btnElement) {
             const userJson = localStorage.getItem('userData');
             if(!userJson) { alert('Faça login!'); window.location.href = 'login.html'; return; }
             const user = JSON.parse(userJson);
             
             if(confirm("Deseja se inscrever nesta oportunidade?")) {
                 try {
                    const response = await fetch('/api/inscricao', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ usuario_cpf: user.cpf, oportunidade_id: id })
                    });
                    const res = await response.json();
                    
                    if(response.ok) {
                        // Atualiza visualmente
                        btnElement.innerHTML = '<i class="fa-solid fa-check"></i> Inscrito';
                        btnElement.className = 'btn-inscrito'; 
                        btnElement.style.marginTop = '10px';
                        btnElement.style.width = '100%';
                        btnElement.disabled = true;
                        
                        // Adiciona à lista global para não perder o status se filtrar
                        idsInscritosGlobal.push(id);
                    } else {
                        alert(res.message);
                    }
                 } catch(e) { console.error(e); alert("Erro de conexão."); }
             }
        }
    </script>
</body>
</html>