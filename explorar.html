<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorar</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fa-regular fa-heart"></i>
                </div>
                <span>Voluntariado<br><strong>Liferay</strong></span>
            </div>

            <nav class="navigation">
                <p>Navega√ß√£o</p>
                <ul>
                    <li><a href="inicio.html"><i class="fa-solid fa-house"></i> In√≠cio</a></li>
                    <li><a href="explorar.html" class="active"><i class="fa-solid fa-magnifying-glass"></i> Explorar</a></li>
                    <li><a href="criar-oportunidade.html"><i class="fa-solid fa-circle-plus"></i> Criar Oportunidade</a></li>
                    <li><a href="impacto.html"><i class="fa-solid fa-chart-line"></i> Impacto</a></li>
                    <li><a href="testemunhos.html"><i class="fa-solid fa-comments"></i> Testemunhos</a></li>
                    <li><a href="MeuPerfil.html"><i class="fa-solid fa-user"></i> Meu perfil</a></li>
                </ul>
            </nav>

            <div class="sidebar-footer">
                <a href="MeuPerfil.html" class="user-info-link">
                    <div class="user-info">
                        <div class="avatar-small">...</div>
                        <div class="user-details">
                            <strong>Carregando...</strong>
                            <span id="sidebar-horas">0h de voluntariado</span>
                        </div>
                    </div>
                </a>
                
                <button class="logout-button">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Sair
                </button>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="explore-header">
                <h1>Explorar Oportunidades</h1>
                <p>Encontre a causa perfeita para voc√™</p>
            </div>

            <div class="filter-bar">
                <div class="search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Buscar por t√≠tulo, descri√ß√£o ou organiza√ß√£o...">
                </div>
                <button class="filter-button">
                    <i class="fa-solid fa-filter"></i>
                    Filtrar
                </button>
            </div>

            <section class="opportunity-grid" id="grid-oportunidades">
                <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #777;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size: 30px; color: #007bff; margin-bottom: 15px;"></i>
                    <p>Buscando oportunidades dispon√≠veis...</p>
                </div>
            </section>

        </main>
    </div>
    
    <script src="app.js"></script>

    <script>
        // =====================================================================
        // L√ìGICA ESPEC√çFICA DA P√ÅGINA EXPLORAR
        // =====================================================================

        // Vari√°vel global para armazenar TODOS os dados vindos do banco.
        // Isso permite filtrar localmente sem precisar chamar a API a cada letra digitada.
        let todasOportunidades = [];

        // Inicializa√ß√£o: Carrega dados assim que o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', carregarOportunidades);

        // Configura√ß√£o da Busca em Tempo Real
        const searchInput = document.querySelector('.search-box input');
        searchInput.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            filtrarOportunidades(termo);
        });

        /**
         * 1. BUSCAR DADOS (FETCH)
         * Busca todas as oportunidades na API e salva na vari√°vel global.
         */
        async function carregarOportunidades() {
            try {
                const response = await fetch('/api/oportunidades');
                
                if (!response.ok) throw new Error("Falha ao buscar dados");

                todasOportunidades = await response.json();
                
                // Renderiza a lista completa inicialmente
                renderizarGrid(todasOportunidades);

            } catch (error) { 
                console.error("Erro ao carregar oportunidades:", error); 
                // Mostra erro visual para o usu√°rio
                const grid = document.getElementById('grid-oportunidades');
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fa-solid fa-triangle-exclamation" style="font-size: 30px; margin-bottom: 10px;"></i>
                        <p>N√£o foi poss√≠vel carregar as oportunidades. Verifique se o servidor est√° rodando.</p>
                    </div>`;
            }
        }

        /**
         * 2. FILTRAR LISTA (L√≥gica Local)
         * Filtra o array global baseado no texto digitado (T√≠tulo ou ONG).
         */
        function filtrarOportunidades(termo) {
            const filtradas = todasOportunidades.filter(op => {
                const titulo = op.titulo.toLowerCase();
                // Verifica se existe institui√ß√£o, sen√£o usa string vazia para n√£o quebrar
                const ong = op.instituicao ? op.instituicao.nomeInstituicao.toLowerCase() : '';
                
                // Retorna true se o termo estiver no t√≠tulo OU na ONG
                return titulo.includes(termo) || ong.includes(termo);
            });
            // Redesenha a tela apenas com os itens filtrados
            renderizarGrid(filtradas);
        }

        /**
         * 3. RENDERIZAR GRID (Visual)
         * Recebe uma lista (completa ou filtrada) e cria o HTML dos cards.
         */
        function renderizarGrid(lista) {
            const grid = document.getElementById('grid-oportunidades');
            grid.innerHTML = ''; // Limpa o loading ou conte√∫do anterior

            // Estado Vazio (Busca sem resultados)
            if (lista.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #777;">
                        <i class="fa-regular fa-folder-open" style="font-size: 30px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>Nenhuma oportunidade encontrada.</p>
                    </div>`;
                return;
            }

            // Loop para criar cada Card
            lista.forEach(op => {
                const card = document.createElement('div');
                card.className = 'opportunity-card';
                
                // Tratamento de Data (Ajuste de fuso hor√°rio)
                const dataObj = new Date(op.data_evento);
                const dataUser = new Date(dataObj.getTime() + dataObj.getTimezoneOffset() * 60000);
                const dataFormatada = dataUser.toLocaleDateString('pt-BR');
                
                // Tratamento de Nome da ONG
                const nomeOng = op.instituicao ? op.instituicao.nomeInstituicao : 'Organiza√ß√£o';

                // Mapa de Cores para Tags (Visual)
                let tagClass = 'tag-blue';
                const tipo = op.tipo_voluntariado ? op.tipo_voluntariado.tipo : 'Geral';
                const mapTipos = { 
                    'Meio Ambiente': 'tag-green', 
                    'Educa√ß√£o': 'tag-purple', 
                    'Sa√∫de': 'tag-red', 
                    'Cultura': 'tag-red', 
                    'Assist√™ncia Social': 'tag-yellow' 
                };
                if(mapTipos[tipo]) tagClass = mapTipos[tipo];

                // Template HTML do Card
                card.innerHTML = `
                    <img src="${op.imagem_url}" alt="${op.titulo}">
                    <div class="card-content">
                        <span class="tag ${tagClass}">${tipo}</span>
                        <h3>${op.titulo}</h3>
                        <p>${op.descricao ? op.descricao.substring(0, 100) + '...' : ''}</p>
                        
                        <div class="card-info">
                            <span><i class="fa-solid fa-building"></i> ${nomeOng}</span>
                            <span><i class="fa-solid fa-location-dot"></i> ${op.local_evento}</span>
                            <span><i class="fa-solid fa-calendar-days"></i> ${dataFormatada}</span>
                            <span><i class="fa-regular fa-clock"></i> ${op.horario}</span>
                        </div>

                        <a href="explorar-detalhe.html?id=${op.idoportunidade}" class="details-button">Ver detalhes</a>
                        
                        <button onclick="inscreverDinamicamente(${op.idoportunidade})" class="inscricao-btn-explorar">
                            <i class="fa-regular fa-heart"></i> Inscreva-se
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        /**
         * 4. FUN√á√ÉO DE INSCRI√á√ÉO
         * Gerencia o clique no bot√£o "Inscreva-se" direto do card.
         */
        async function inscreverDinamicamente(id) {
             // Verifica Sess√£o
             const userJson = localStorage.getItem('userData');
             if(!userJson) { 
                 alert('Fa√ßa login para se inscrever!'); 
                 window.location.href = 'login.html';
                 return; 
             }
             const user = JSON.parse(userJson);
             
             // Confirma√ß√£o e Envio
             if(confirm("Deseja se inscrever nesta oportunidade?")) {
                 try {
                    const response = await fetch('/api/inscricao', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ usuario_cpf: user.cpf, oportunidade_id: id })
                    });
                    const res = await response.json();
                    
                    if(response.ok) {
                        alert("Inscri√ß√£o realizada com sucesso! üéâ");
                    } else {
                        alert(res.message); // Ex: "J√° inscrito"
                    }
                 } catch(e) {
                     console.error(e);
                     alert("Erro de conex√£o.");
                 }
             }
        }
    </script>
</body>
</html>